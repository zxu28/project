{"version":3,"sources":["../../../src/prebuild/prebuildAsync.ts"],"sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport { ModPlatform } from '@expo/config-plugins';\nimport chalk from 'chalk';\n\nimport { clearNativeFolder, promptToClearMalformedNativeProjectsAsync } from './clearNativeFolder';\nimport { configureProjectAsync } from './configureProjectAsync';\nimport { ensureConfigAsync } from './ensureConfigAsync';\nimport { assertPlatforms, ensureValidPlatforms, resolveTemplateOption } from './resolveOptions';\nimport { updateFromTemplateAsync } from './updateFromTemplate';\nimport { installAsync } from '../install/installAsync';\nimport { Log } from '../log';\nimport { env } from '../utils/env';\nimport { setNodeEnv } from '../utils/nodeEnv';\nimport { clearNodeModulesAsync } from '../utils/nodeModules';\nimport { logNewSection } from '../utils/ora';\nimport { profile } from '../utils/profile';\nimport { confirmAsync } from '../utils/prompts';\n\nconst debug = require('debug')('expo:prebuild') as typeof console.log;\n\nexport type PrebuildResults = {\n  /** Expo config. */\n  exp: ExpoConfig;\n  /** Indicates if the process created new files. */\n  hasNewProjectFiles: boolean;\n  /** The platforms that were prebuilt. */\n  platforms: ModPlatform[];\n  /** Indicates if pod install was run. */\n  podInstall: boolean;\n  /** Indicates if node modules were installed. */\n  nodeInstall: boolean;\n};\n\n/**\n * Entry point into the prebuild process, delegates to other helpers to perform various steps.\n *\n * 0. Attempt to clean the project folders.\n * 1. Create native projects (ios, android).\n * 2. Install node modules.\n * 3. Apply config to native projects.\n * 4. Install CocoaPods.\n */\nexport async function prebuildAsync(\n  projectRoot: string,\n  options: {\n    /** Should install node modules and cocoapods. */\n    install?: boolean;\n    /** List of platforms to prebuild. */\n    platforms: ModPlatform[];\n    /** Should delete the native folders before attempting to prebuild. */\n    clean?: boolean;\n    /** URL or file path to the prebuild template. */\n    template?: string;\n    /** Name of the node package manager to install with. */\n    packageManager?: {\n      npm?: boolean;\n      yarn?: boolean;\n      pnpm?: boolean;\n      bun?: boolean;\n    };\n    /** List of node modules to skip updating. */\n    skipDependencyUpdate?: string[];\n  }\n): Promise<PrebuildResults | null> {\n  setNodeEnv('development');\n  require('@expo/env').load(projectRoot);\n\n  const { platforms } = getConfig(projectRoot).exp;\n  if (platforms?.length) {\n    // Filter out platforms that aren't in the app.json.\n    const finalPlatforms = options.platforms.filter((platform) => platforms.includes(platform));\n    if (finalPlatforms.length > 0) {\n      options.platforms = finalPlatforms;\n    } else {\n      const requestedPlatforms = options.platforms.join(', ');\n      Log.warn(\n        chalk`⚠️  Requested prebuild for \"${requestedPlatforms}\", but only \"${platforms.join(', ')}\" is present in app config (\"expo.platforms\" entry). Continuing with \"${requestedPlatforms}\".`\n      );\n    }\n  }\n  if (options.clean) {\n    const { maybeBailOnGitStatusAsync } = await import('../utils/git.js');\n    // Clean the project folders...\n    if (await maybeBailOnGitStatusAsync()) {\n      return null;\n    }\n    // Clear the native folders before syncing\n    await clearNativeFolder(projectRoot, options.platforms);\n  } else {\n    // Check if the existing project folders are malformed.\n    await promptToClearMalformedNativeProjectsAsync(projectRoot, options.platforms);\n  }\n\n  // Warn if the project is attempting to prebuild an unsupported platform (iOS on Windows).\n  options.platforms = ensureValidPlatforms(options.platforms);\n  // Assert if no platforms are left over after filtering.\n  assertPlatforms(options.platforms);\n\n  // Get the Expo config, create it if missing.\n  const { exp, pkg } = await ensureConfigAsync(projectRoot, { platforms: options.platforms });\n\n  // Create native projects from template.\n  const { hasNewProjectFiles, needsPodInstall, templateChecksum, changedDependencies } =\n    await updateFromTemplateAsync(projectRoot, {\n      exp,\n      pkg,\n      template: options.template != null ? resolveTemplateOption(options.template) : undefined,\n      platforms: options.platforms,\n      skipDependencyUpdate: options.skipDependencyUpdate,\n    });\n\n  // Install node modules\n  if (options.install) {\n    if (changedDependencies.length) {\n      if (options.packageManager?.npm) {\n        await clearNodeModulesAsync(projectRoot);\n      }\n\n      Log.log(chalk.gray(chalk`Dependencies in the {bold package.json} changed:`));\n      Log.log(chalk.gray('  ' + changedDependencies.join(', ')));\n\n      // Installing dependencies is a legacy feature from the unversioned\n      // command. We know opt to not change dependencies unless a template\n      // indicates a new dependency is required, or if the core dependencies are wrong.\n      if (\n        await confirmAsync({\n          message: `Install the updated dependencies?`,\n          initial: true,\n        })\n      ) {\n        await installAsync([], {\n          npm: !!options.packageManager?.npm,\n          yarn: !!options.packageManager?.yarn,\n          pnpm: !!options.packageManager?.pnpm,\n          bun: !!options.packageManager?.bun,\n          silent: !(env.EXPO_DEBUG || env.CI),\n        });\n      }\n    }\n  }\n\n  // Apply Expo config to native projects. Prevent log-spew from ora when running in debug mode.\n  const configSyncingStep: { succeed(text?: string): unknown; fail(text?: string): unknown } =\n    env.EXPO_DEBUG\n      ? {\n          succeed(text) {\n            Log.log(text!);\n          },\n          fail(text) {\n            Log.error(text!);\n          },\n        }\n      : logNewSection('Running prebuild');\n  try {\n    await profile(configureProjectAsync)(projectRoot, {\n      platforms: options.platforms,\n      exp,\n      templateChecksum,\n    });\n    configSyncingStep.succeed('Finished prebuild');\n  } catch (error) {\n    configSyncingStep.fail('Prebuild failed');\n    throw error;\n  }\n\n  // Install CocoaPods\n  let podsInstalled: boolean = false;\n  // err towards running pod install less because it's slow and users can easily run npx pod-install afterwards.\n  if (options.platforms.includes('ios') && options.install && needsPodInstall) {\n    const { installCocoaPodsAsync } = await import('../utils/cocoapods.js');\n\n    podsInstalled = await installCocoaPodsAsync(projectRoot);\n  } else {\n    debug('Skipped pod install');\n  }\n\n  return {\n    nodeInstall: !!options.install,\n    podInstall: !podsInstalled,\n    platforms: options.platforms,\n    hasNewProjectFiles,\n    exp,\n  };\n}\n"],"names":["prebuildAsync","debug","require","projectRoot","options","setNodeEnv","load","platforms","getConfig","exp","length","finalPlatforms","filter","platform","includes","requestedPlatforms","join","Log","warn","chalk","clean","maybeBailOnGitStatusAsync","clearNativeFolder","promptToClearMalformedNativeProjectsAsync","ensureValidPlatforms","assertPlatforms","pkg","ensureConfigAsync","hasNewProjectFiles","needsPodInstall","templateChecksum","changedDependencies","updateFromTemplateAsync","template","resolveTemplateOption","undefined","skipDependencyUpdate","install","packageManager","npm","clearNodeModulesAsync","log","gray","confirmAsync","message","initial","installAsync","yarn","pnpm","bun","silent","env","EXPO_DEBUG","CI","configSyncingStep","succeed","text","fail","error","logNewSection","profile","configureProjectAsync","podsInstalled","installCocoaPodsAsync","nodeInstall","podInstall"],"mappings":"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"}